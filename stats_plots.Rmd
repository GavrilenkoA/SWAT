---
title: "lme4_iDCT"
author: "Luiz"
date: "2024-06-08"
output: html_document
---

# Loading libraries
```{r}
library(here)
library(lme4)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(multcomp)
library(broom)
# for later plotting
library(cowplot)
library(scales)


```


# Data preprocessing
```{r}
data <- read.csv(here("summary_DMS_results_lassoCV_clean.csv"))
data <- dplyr::select(data, Dataset, Compression_methd, Fold, R2_score_test, rho_score_test)
data <- filter(data, Dataset != "HIS7 YEAST")


data

# Convert categorical variables to factors and releveling the mean to be the reference group
data$Compression_methd <- factor(data$Compression_methd)
data$Compression_methd <- relevel(data$Compression_methd, ref = "mean")
data$Dataset <- factor(data$Dataset)
data$Fold <- factor(data$Fold)
data
```



# Fiting the lme4 model

Dependent Variable: The dependent variable (response). Here is R2_score_test.       

Fixed Effect: The predictor variables (fixed effects) can be numeric or categorical. Categorical variables should be factors.   
'Compression_methd' is included as a fixed effect to see how different compression methods influence the R2_score_test.     

Random Effects: The grouping variables (random effects) should be factors. In here are Dataset and Fold.   
Both Dataset and Fold are included as random effects to account for variability across datasets and cross-validation folds.  

```{r}
model <- lmer(R2_score_test ~ Compression_methd + (1 | Dataset) + (1|Fold), data=data)
#model <- lmer(R2_score_test ~ Compression_methd + (1 | Dataset), data=data)
########model <- lmer(rho_score_test ~ Compression_methd + (1 | Dataset) + (1|Fold), data=data)
#model <- lmer(rho_score_test ~ Compression_methd + (1 | Dataset), data=data)
summary(model)
```



```{r}
#glht_results <- summary(glht(model, linfct=c('Compression_methdbos=0',
#                             'Compression_methdiDCT=0',
#                              'Compression_methdmaxPool=0',
#                              'Compression_methdpca1=0',
#                              '`Compression_methdpca1-2`=0',
#                              'Compression_methdpca2=0',
#                              'Compression_methdrbf1=0',
#                              'Compression_methdrbf2=0',
#                              'Compression_methdsigmoid1=0',
#                              'Compression_methdsigmoid2=0')))



glht_results <- summary(glht(model, linfct=c(
                              'Compression_methdbos=0',
                              'Compression_methdiDCT1=0',
                              'Compression_methdiDCT2=0',
                              'Compression_methdiDCT3=0',
                              'Compression_methdiDCT4=0',
                              'Compression_methdiDCT5=0',
                              'Compression_methdmaxPool=0',
                              'Compression_methdpca1=0',
                              '`Compression_methdpca1-2`=0',
                              'Compression_methdpca2=0',
                              'Compression_methdrbf1=0',
                              'Compression_methdrbf2=0',
                              'Compression_methdsigmoid1=0',
                              'Compression_methdsigmoid2=0')))

glht_results 
```


```{r}
#summary(glht(model, linfct=mcp(Compression_methd="Tukey")))
```


## Interpretation


The intercept in a regression model represents the expected value of the dependent variable (in this case, R2_score_test) 
when all predictor variables are set to zero. It's the baseline value from which other effects are measured.


Fixed effects are the estimated coefficients for the predictor variables in the model. These effects are assumed to be the 
same across all groups in the dataset. In your model, Compression_methd is treated as a fixed effect, meaning its impact on 
R2_score_test is consistent across all datasets.

Random effects account for variability within the data that is not explained by the fixed effects. They allow the model to 
consider differences across groups (e.g., different datasets or cross-validation folds). For example, if some datasets inherently
have higher or lower R2 scores, this variability is captured by including Dataset as a random effect.

Residuals are the differences between the observed values and the values predicted by the model. They represent the "error" 
or "noise" in the model. Residual analysis helps to check the assumptions of the model (e.g., normality and homoscedasticity 
of residuals).



# Evaluating individual datasets

```{r}
# Tidy the results
tidy_glht <- tidy(glht_results)
#tidy_glht<- tidy_glht %>% dplyr::filter(contrast != #'Compression_methdiDCT')

ci <- tidy(confint(glht_results)) %>% dplyr::select("contrast", "conf.high", "conf.low")

res_glht = merge(tidy_glht, ci, by = 'contrast')



res_glht$contrast <- gsub("Compression_methd", "", res_glht$contrast)

#res_glht$contrast <- gsub("iDCT2", "iDCT", res_glht$contrast)


# Determine significance levels
res_glht$signif <- ifelse(res_glht$adj.p.value < 0.001, "***",
                 ifelse(res_glht$adj.p.value < 0.01, "**",
                 ifelse(res_glht$adj.p.value < 0.05, "*", "")))



res_glht
```



# Plotting lmer
```{r}
#, fig.width=2.5, fig.height=6, out.width = 100%, out.height = 100%
# Adding Confidence Intervals
#tidy_glht$Lower_CI <- tidy_glht$estimate - 1.96 * tidy_glht$std.error
#tidy_glht$Upper_CI <- tidy_glht$estimate + 1.96 * tidy_glht$std.error



final_plot <- res_glht %>%
  ggplot(aes(y = fct_reorder(contrast, estimate), 
             x = estimate, 
             color = contrast
             )) +
  geom_point() +
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0.2) +
  theme_minimal() +
  labs(
       y = "Compression Method",
       x = "Difference from the Mean R2", # change to difference from the mean, was "Difference in Means"
       ) +
  geom_vline(xintercept = 0, linetype = "dotted", color = '#0072B2', linewidth = 1) +
  geom_text(aes(label = signif), 
            #.001
            nudge_x = .045, 
            #vjust = -.1, 
            angle = 0, 
            size = 3) +
  scale_color_manual(
    values = c("mean" = '#0072B2', "maxPool" = '#D55E00', 'pca1-2' = '#710e5c', 'bos' = "#000000", 
               'iDCT1' = '#000000', 'iDCT2' = '#000000', 'iDCT3' = '#000000', 'iDCT4' = '#000000', 
               'iDCT5' = '#000000', 'pca1' = '#000000', 'pca2' = '#000000', 
               'rbf1' = "#000000", 'rbf2' = "#000000", 'sigmoid1' = "#000000", 'sigmoid2' = "#000000"),
    guide = "none"
  ) +
  scale_x_continuous(limit = c(-.25, 0.05), # c(-.13, 0.1)
                     #breaks = seq(-0.1, 0.1, by = 0.1)
                     ) + 
   theme_minimal_vgrid(12, rel_small = 1) +  
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.background = element_rect(fill = "white", colour = "white"),
    axis.text.x=element_text(size=12),
    axis.text.y=element_text(size=10),
    #axis.title.x=element_text(size=10),
    #axis.title.y=element_text(size=10),
    panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
    axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
    plot.margin = margin(43, 15, 140, 0)
  )

ggsave(final_plot, 
       filename = "lmer_lme4_all_R2.png",
       path = here("figs"),
       width = 6,
       height = 8,
       dpi=600)


final_plot
  
```

# 150M Scatter


```{r}
methods = c('mean', 'maxPool', 'pca1-2')



grouped_data <- data %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()


mean_data <- grouped_data %>%
  filter(Compression_methd == "mean")

ordered_levels <- mean_data %>%
  arrange(mean_score) %>%
  pull(Dataset)

grouped_data <- grouped_data %>%
  mutate(Dataset = factor(Dataset, levels = ordered_levels))




```

```{r}
#, fig.width=4, fig.height=8, out.width = 100%, out.height = 100%
custom_colors <- c("mean" = '#0072B2', "maxPool" = '#D55E00', 'pca1-2' = '#710e5c')


scatter_150M <- grouped_data %>%
  ggplot(aes(
      x = mean_score, 
      y = Dataset, #fct_reorder(Dataset, mean_score), 
      color = Compression_methd)) +
  geom_point(alpha = 1
    #position = position_dodge(width=1)
             ) +
  geom_errorbarh(aes(
      xmin = mean_score - std_score, 
      xmax = mean_score + std_score), 
      height = 0.3,
      alpha = .7
      ) +
      scale_x_continuous(limits = c(0, .8)) + #.2 to .9
  scale_color_manual(values = custom_colors) +
  labs(x = "R2", y = "", color = "Compression Method") +
  
  theme_minimal_vgrid(12, rel_small = 1)+
  theme(
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
        legend.position = "top",
        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.text.y = element_text(size = 10),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),

        
        plot.margin = margin(0, 20, 0, 0)) +
  guides(color = guide_legend(title.position = "top"))


ggsave(scatter_150M, 
       filename = "scatter_150M_R2.png",
       path = here("figs"),
       width = 8,
       height = 10, #8
       dpi=600)


scatter_150M
```



# 15B vs 150M Boxplot (not updated)

```{r}

data_15B <- read.csv(here('summary_15B_clean.csv'))

data_650M <- read.csv(here('summary_650M_DMS.csv'))

methods = c('mean', 'iDCT')


grouped_15B <- data_15B %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('rho_score_test'), na.rm = TRUE),
    std_score = sd(get('rho_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()

grouped_15B$param <- '15B'

grouped_data$param <- '150M'

grouped_650M <- data_650M %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('rho_score_test'), na.rm = TRUE),
    std_score = sd(get('rho_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()

grouped_650M$param <- '650M'


combined_150M_650M_15B <- rbind(grouped_data, grouped_650M, grouped_15B)

grouped_150M_650M_15B <- combined_150M_650M_15B %>%
  mutate(param = factor(param, levels = c("150M", "650M", "15B")))


```


```{r, fig.width=3, fig.height=3, out.width = 100%, out.height = 100%}

color_dict <- c('mean' = '#0072B2', 'iDCT' = '#D55E00')

boxplot_15B_150M <- grouped_150M_650M_15B %>%
  ggplot(aes(x = param, y = mean_score, fill = Compression_methd)) +
  geom_boxplot() +
  scale_fill_manual(values = color_dict) +
  ylim(0.5, 1) +
  labs(x = "Model", y = "|Spearman ρ|", fill = "Compression Method   ") +
  theme_minimal_hgrid(12, rel_small = 1)+
  theme(
        legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(20, 20, 20, 20))
        
  

ggsave(boxplot_15B_150M, 
       filename = "boxplot_R.png",
       path = here('figs'),
       width = 6,
       height = 4,
       dpi=600)


boxplot_15B_150M

```





# protein gym
```{r}

protein_gym <- read.csv(here('protein_gym_clean.csv'))

#reshape for combination
data_wide <- grouped_data %>%
  dplyr::select(Dataset, Compression_methd, mean_score) %>%
  pivot_wider(names_from = Compression_methd, values_from = mean_score)

#pull from above 150M data
protein_combined <- right_join(data_wide, protein_gym, by = "Dataset")

# gotta reshape again..
protein_long <- protein_combined %>%
  pivot_longer(cols = -Dataset, names_to = "Model", values_to = "Spearman")


protein_long$Model <- factor(protein_long$Model, levels = unique(protein_long$Model))

specific_colors <- c("mean" = '#0072B2', "iDCT" = '#D55E00')
default_color <- '#d3d3d3'

protein_long$Model <- gsub("\\.\\.\\.", "\\ \\+\\ ", protein_long$Model)
protein_long$Model <- gsub("\\.", "\\ ", protein_long$Model)
protein_long$Model <- gsub("\\_", "\\ ", protein_long$Model)
protein_long$Model <- gsub("One Hot Encodings", "OHE", protein_long$Model)
protein_long$Model <- gsub("MSA Transformer Embeddings", "MSA Transformer", protein_long$Model)
protein_long$Model <- gsub("Tranception Embeddings", "Tranception", protein_long$Model)
protein_long$Model <- gsub("ESM 1v Embeddings", "ESM 1v", protein_long$Model)

unique_models <- unique(protein_long$Model)


color_map <- ifelse(unique_models %in% names(specific_colors), 
                    specific_colors[unique_models], 
                    default_color)

color_map <- setNames(color_map, unique_models)






```


```{r, fig.width=4, fig.height=8, out.width = 100%, out.height = 100%}


protein_boxplot <- protein_long %>%
  ggplot(aes(y = fct_reorder(Model, Spearman), x = Spearman, fill = Model)) +
  geom_boxplot() +
  scale_fill_manual(values = color_map) +
  theme_minimal_vgrid(12, rel_small = 1)+
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    legend.position = "none",
    plot.background = element_rect(fill = "white", colour = "white"),
    panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
    axis.line = element_blank(),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.y = element_line(color = "black"),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank()
    plot.margin = margin(20, 20, 20, 0)
    ) +
  labs(y = " ", x = "|Spearman ρ|")


ggsave(protein_boxplot, 
       filename = "protein_gym_R.png",
       path = here("figs"),
       width = 6,
       height = 4,
       dpi=600)



protein_boxplot

```


# rank
```{r}

rank_df = read_csv(here('summary_benchmarks_rank.csv'))

specific_colors <- c("ESM2 150M - MEAN" = '#0072B2', "ESM2 150M - iDCT" = '#D55E00')
default_color <- '#d3d3d3'

unique_models <- unique(rank_df$Method)


color_map <- ifelse(unique_models %in% names(specific_colors), 
                    specific_colors[unique_models], 
                    default_color)

color_map <- setNames(color_map, unique_models)
```

```{r}

ranked_boxplot <- rank_df %>%
  ggplot(aes(y = fct_reorder(Method, Rank, .desc = TRUE), x = Rank, fill = Method)) +
  geom_boxplot() +
  scale_fill_manual(values = color_map) +
  theme_minimal_vgrid(12, rel_small = 1)+
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    legend.position = "none",
    plot.background = element_rect(fill = "white", colour = "white"),
    panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
    axis.line = element_blank(),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.y = element_line(color = "black"),
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank()
    plot.margin = margin(20, 20, 20, 0)
    ) +
  labs(y = " ", x = "Rank")


ggsave(ranked_boxplot, 
       filename = "ranked_boxplot.png",
       path = here('figs'),
       width = 8,
       height = 6,
       dpi=600)



ranked_boxplot

```







# torch summary
```{r}
torch_data <- read.csv(here('summary_benchmarks.csv'))

# plan
# group data into respective categories (DMS, diverse, mid)
# make 3 individual plots based on meowing
# use cowplot to stitch together

# exclude solutbility for now since we don't know what dataset it belongs to also it is classification


torch_dms <- filter(torch_data, (Dataset %in% c('beta_lactamase', 'fluorescence')))
torch_dms$Dataset <- gsub("beta_lactamase", "B-Lac", torch_dms$Dataset)
torch_dms$Dataset <- gsub("fluorescence", "Fluorescence", torch_dms$Dataset)

torch_mid <- filter(torch_data, (Dataset %in% c('subcellular_localization', 'subcellular_localization_2')))
torch_mid$accuracy <- torch_mid$accuracy * 100
torch_mid$Dataset <- gsub("subcellular_localization", "Cell-Loc", torch_mid$Dataset)
torch_mid$Dataset <- gsub("subcellular_localization_2", "`Cell-Loc2`", torch_mid$Dataset)


torch_diverse <- filter(torch_data, (Dataset %in% c('solubility')))
torch_diverse$accuracy <- torch_diverse$accuracy * 100


torch_stable <- filter(torch_data, (Dataset %in% c('stability')))



```


```{r}

color_dict <- c('mean' = '#0072B2', 'iDCT' = '#D55E00')

scaleFUN <- function(x) sprintf("%.2f", x)


torch_dms_box <- torch_dms %>%
  ggplot(aes(x = Compression_methd, y = rho, fill = Compression_methd)) +
  geom_boxplot(size = 0.25) +
  scale_y_continuous(labels=label_number(accuracy = 0.01)) + 
  scale_fill_manual(values = color_dict) +
  #ylim(.4, .7) +
  labs(x = "DMS", y = "|Spearman ρ|", fill = "Compression Method") +
  theme_minimal_hgrid(12, rel_small = 1)+
  theme(
        legend.position = "none",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 10, 10)
        ) 
        
  
torch_mid_box <- torch_mid %>%
  ggplot(aes(x = Compression_methd, y = accuracy, fill = Compression_methd)) +
  geom_boxplot(size = 0.25) +
  scale_fill_manual(values = color_dict) +
  ylim(70, 90) +
  labs(x = "Homologous", y = "Accuracy %", fill = "Compression Method") +
  theme_minimal_hgrid(12, rel_small = 1)+
  theme(
        legend.position = "none",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 10, 10)
        )

torch_diverse_box <- torch_diverse %>%
  ggplot(aes(x = Compression_methd, y = accuracy, fill = Compression_methd)) +
  geom_boxplot(size = 0.25) +
  scale_fill_manual(values = color_dict) +
  ylim(62, 70) +
  labs(x = "Diverse", y = "Accuracy %", fill = "Compression Method") +
  theme_minimal_hgrid(12, rel_small = 1)+
  theme(
        legend.position = "none",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 10, 10)
        )


torch_stable_box <- torch_stable %>%
  ggplot(aes(x = Compression_methd, y = rho, fill = Compression_methd)) +
  geom_boxplot(size = 0.25) +
  scale_fill_manual(values = color_dict) +
  ylim(.65, .8) +
  labs(x = "Mix", y = "|Spearman ρ|", fill = "Compression Method") +
  theme_minimal_hgrid(12, rel_small = 1)+
  theme(
        legend.position = "none",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 10, 10)
        )

```


```{r}
torch_dms_box

```


```{r}

custom_legend <- ggplot() +
  annotate("text", x = 1, y = 2, label = "Compression Method", size = 5, hjust = 0) +
  geom_point(aes(x = 1.5, y = 2.5), color = "#D55E00", size = 5) +
  annotate("text", x = 1.6, y = 2.5, label = "iDCT", hjust = 0, vjust = 0.5, size = 4) +
  geom_point(aes(x = 1.5, y = 1.5), color = "#0072B2", size = 5) +
  annotate("text", x = 1.6, y = 1.5, label = "mean", hjust = 0, vjust = 0.5, size = 4) +
  xlim(0.8, 2) + ylim(1, 4) + 
  theme_void() +
  theme(plot.margin = margin(0, 0, 0, 5),
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),)



torch_2x2 <- plot_grid(torch_dms_box + facet_grid(. ~ Dataset), torch_mid_box + facet_grid(. ~ Dataset),  torch_stable_box, torch_diverse_box)

torch_all <- plot_grid(custom_legend, torch_2x2, ncol = 1, rel_heights = c(0.1, 1))


ggsave(torch_all, 
       filename = "torch_all.png",
       path = here("figs"),
       width = 7,
       height = 8,
       dpi=600)

torch_all



```




# Pisces Data Preprocessing
```{r}
pisces_data <- read.csv(here('summary_150M_pisces_results_lassoCV.csv'))
#'Pisces_summary.csv'
pisces_data <- dplyr::select(pisces_data, c('Dataset', 'Compression_methd', 'Fold', 'R2_score_test', 'rho_score_test'))

#pisces_data <- filter(pisces_data, !Dataset %in% c('W freq', 'M freq','V freq', 'Y freq', 'D freq','C freq', 'F freq'))
pisces_data

# Convert categorical variables to factors and releveling the mean to be the reference group
pisces_data$Compression_methd <- factor(pisces_data$Compression_methd)
pisces_data$Compression_methd <- relevel(pisces_data$Compression_methd, ref = "mean")
pisces_data$Dataset <- factor(pisces_data$Dataset)
pisces_data$Fold <- factor(pisces_data$Fold)
pisces_data

```


```{r}
pisces_model <- lmer(R2_score_test ~ Compression_methd + (1 | Dataset) + (1|Fold), data=pisces_data)
summary(pisces_model)
```

```{r}
pisces_glht_results <- summary(glht(pisces_model, linfct=c('Compression_methdbos=0',
                             'Compression_methdiDCT1=0',
                             'Compression_methdiDCT2=0',
                             'Compression_methdiDCT3=0',
                             'Compression_methdiDCT4=0',
                             'Compression_methdiDCT5=0',
                              'Compression_methdmaxPool=0',
                              'Compression_methdpca1=0',
                              '`Compression_methdpca1-2`=0',
                              'Compression_methdpca2=0',
                              'Compression_methdrbf1=0',
                              'Compression_methdrbf2=0',
                              'Compression_methdsigmoid1=0',
                              'Compression_methdsigmoid2=0')))

pisces_glht_results 

```

```{r}
# Tidy the results
pisces_tidy_glht <- tidy(pisces_glht_results)

pisces_ci <- tidy(confint(pisces_glht_results)) %>% dplyr::select("contrast", "conf.high", "conf.low")

pisces_res_glht = merge(pisces_tidy_glht, pisces_ci, by = 'contrast')



pisces_res_glht$contrast <- gsub("Compression_methd", "", pisces_res_glht$contrast)


# Determine significance levels
pisces_res_glht$signif <- ifelse(pisces_res_glht$adj.p.value < 0.001, "***",
                 ifelse(pisces_res_glht$adj.p.value < 0.01, "**",
                 ifelse(pisces_res_glht$adj.p.value < 0.05, "*", "")))



pisces_res_glht
```


# pisces lmer
```{r, fig.width=4, fig.height=8, out.width = 100%, out.height = 100%}

pisces_plot <- pisces_res_glht %>%
  ggplot(aes(y = fct_reorder(contrast, estimate), x = estimate, color = contrast)) +
  geom_point() +
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0.2) +
  theme_minimal() +
  labs(
       y = "Compression Method",
       x = "Difference in Means R2",
       ) +
  geom_vline(xintercept = 0, linetype = "dotted", color = '#0072B2', linewidth = 1) +
  geom_text(aes(label = signif), 
            nudge_x = .1, 
            #vjust = 3, 
            angle = 0, 
            size = 3) +
  scale_color_manual(
    values = c("mean" = '#0072B2', "maxPool" = '#D55E00', 'pca1-2' = "#000000", 'bos' = '#009E10', 
               'iDCT1' = '#000000', 'iDCT2' = '#000000', 'iDCT3' = '#000000', 'iDCT4' = '#000000', 
               'iDCT5' = '#000000', 'pca1' = '#000000', 'pca2' = '#000000', 
               'rbf1' = "#000000", 'rbf2' = "#000000", 'sigmoid1' = "#000000", 'sigmoid2' = "#000000"),
    guide = "none"
  ) +
  scale_x_continuous(limit = c(-.85, 0),
                     breaks = seq(-0.8, 0, by = 0.4)
                     ) + 
   theme_minimal_vgrid(12, rel_small = 1) +  
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.background = element_rect(fill = "white", colour = "white"),
    axis.text.y=element_text(size=10),
    #axis.title.x=element_text(size=10),
    #axis.title.y=element_text(size=10),
    panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
    axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
    plot.margin = margin(43, 15, 140, 0)
  )

ggsave(pisces_plot, 
       filename = "pisces_lme4_lassoCV.png",
       path = here("figs"),
       width = 6,
       height = 8,
       dpi=600)


pisces_plot
  
```


# scatter plot pisces
```{r}
methods = c('mean', 'bos', 'maxPool')


grouped_pisces <- pisces_data %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()

```
```{r}


#GQSPHT
exclude_datasets <- c('F freq', 'M freq', 'C freq', 'D freq', 'Y freq', 'V freq', 'W freq', 'G freq', 'Q freq', 'S freq', 'P freq', 'H freq', 'T freq')

# order:
#new_order = c('F freq', 'M freq', 'C freq', 'D freq', 'T freq', 'Y freq', 'H freq', 'P freq', 'V freq', 'S freq', 'Q freq', 'G freq', 'Instability index', 'I freq', 'N freq', 'L freq', 'E freq', 'R freq', 'A freq', 'K #freq', 'Isoelectric point', 'SS E', 'Charge', 'SS H', 'Hydrophobicity', 'W freq')


mean_data <- grouped_pisces %>%
  filter(Compression_methd == "mean")

ordered_levels <- mean_data %>%
  arrange(mean_score) %>%
  pull(Dataset)

grouped_pisces <- grouped_pisces %>%
  mutate(Dataset = factor(Dataset, levels = ordered_levels))






```

```{r, fig.width=4, fig.height=8, out.width = 100%, out.height = 100%}

# ggplot(aes(y = fct_reorder(contrast, estimate), x = estimate, color = signif))

custom_colors <- c("mean" = '#0072B2', "maxPool" = '#D55E00', 'bos' = '#009E10')



pisces_scatter <- grouped_pisces %>%
  ggplot(aes(
      x = mean_score, 
      y = Dataset, # fct_reorder(Dataset, mean_score), 
      color = Compression_methd)) +
  geom_point() +
  geom_errorbarh(aes(
      xmin = mean_score - std_score, 
      xmax = mean_score + std_score), 
      height = 0.2,
      alpha = .7) +
      scale_x_continuous(limits = c(.35, 1)) +
  scale_color_manual(values = custom_colors) +
  labs(x = "R2", y = "", color = "Compression Method") +
  theme_minimal_vgrid(12, rel_small = 1)+
  theme(
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
        legend.position = "top",
        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        
        axis.text.y = element_text(size = 10),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),

        plot.margin = margin(0, 20, 0, 0)) +
  guides(color = guide_legend(title.position = "top"))



ggsave(pisces_scatter, 
       filename = "pisces_scatter_R_lassoCV.png",
       path = here('figs'),
       width = 8,
       height = 8,
       dpi=600)


pisces_scatter
```


# pisces 15B v 150M boxplot (not updated)
```{r}

#exclude_datasets <- c('F freq', 'M freq', 'C freq', 'D freq', 'Y freq', 'V freq', 'W freq', 'G freq', 'Q freq', 'S freq', 'P freq', 'H freq', 'T freq')

pisces_15B <- read.csv(here('summary_15B_pisces_results_lassoCV.csv'))

pisces_650M <- read.csv(here('summary_650M_pisces_results_lassoCV.csv'))


methods = c('mean', 'bos', 'maxPool', 'iDCT5')


grouped_pisces <- pisces_data %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()


grouped_pisces_15B <- pisces_15B %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()

grouped_pisces_15B$param <- '15B'

grouped_pisces$param <- '150M'

grouped_pisces_650M <- pisces_650M %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()

grouped_pisces_650M$param <- '650M'


pic_150M_650M_15B <- rbind(grouped_pisces, grouped_pisces_650M, grouped_pisces_15B)

pisces_150M_650M_15B <- pic_150M_650M_15B %>%
  mutate(param = factor(param, levels = c("150M", "650M", "15B")))

#pisces_150M_650M_15B <- filter(pisces_150M_650M_15B, !(Dataset %in% exclude_datasets))


```



```{r}

#color_dict <- c('mean' = '#0072B2', 'iDCT' = '#D55E00')

pisces_boxplot <- pisces_150M_650M_15B %>%
  ggplot(aes(x = param, y = mean_score, fill = Compression_methd)) +
  geom_boxplot() +
  #scale_fill_manual(values = color_dict) +
  ylim(0.5, 1) +
  labs(x = "Model", y = "R2", fill = "Compression Method   ") +
  theme_minimal_hgrid(12, rel_small = 1)+
  theme(
        legend.position = "top",

        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(20, 20, 20, 20))
        
  

ggsave(pisces_boxplot, 
       filename = "pisces_box_R_lassoCV.png",
       path = here("figs"),
       width = 6,
       height = 4,
       dpi=600)


pisces_boxplot

```






# cowplot
```{r}
# cowplot for pisces 150M data

pisces_double <- plot_grid(pisces_scatter,
                  pisces_plot,
                  labels = c('A', 'B'), 
                  label_size = 12, 
                  rel_widths = c(3.5, 2)
                  )


ggsave(pisces_double, 
       filename = "pisces_double.png",
       path = here("figs"),
       width = 10,
       height = 10,
       dpi=600)
pisces_double

```


```{r}
# cowplot for DMS 150M data

double_plot <- plot_grid(scatter_150M,
                  final_plot,
                  labels = c('A', 'B'), 
                  label_size = 12, 
                  rel_widths = c(3.5, 2)
                  )


ggsave(double_plot, 
       filename = "double.png",
       path = here("figs"),
       width = 10,
       height = 10,
       dpi=600)
double_plot

```


# supplementary figs (not updated)

``` {r}

methods_all <- c("mean", "bos", "iDCT", "maxPool", "pca1", "pca1-2", "pca2", "rbf1", "rbf2", "sigmoid1", "sigmoid2")


all_grouped_data <- data %>%
  filter(Compression_methd %in% methods_all) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('rho_score_test'), na.rm = TRUE),
    std_score = sd(get('rho_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()

dataset_list <- split(all_grouped_data, all_grouped_data$Dataset)

```

```{r}
create_plot <- function(all_grouped_data) {
  ggplot(all_grouped_data, aes(y = Compression_methd, x = mean_score, fill = Compression_methd)) +
    geom_bar(stat = "identity", position = position_dodge()) +
    geom_errorbar(aes(xmin = mean_score - std_score, xmax = mean_score + std_score), 
                  width = 0.2, position = position_dodge(0.7)) +
    labs(title = unique(all_grouped_data$Dataset),
         #y = "Compression Method",
         x = "|Spearman ρ|") +
    scale_x_continuous(limits = c(0, 1)) +
    theme_minimal_vgrid() +
    theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    legend.position = "none",
    plot.background = element_rect(fill = "white", colour = "white"),
    panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
    axis.line = element_blank(),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.y = element_line(color = "black"),
    plot.margin = margin(0, 15, 15, 15))
}


plots <- lapply(dataset_list, create_plot)
```



```{r}
#mega_plot <- plot_grid(plotlist = plots, align = 'v', ncol = 4)

#ggsave(mega_plot, 
#       filename = "mega_plot.png",
#       path = here("figs"),
#       width = 20,
#       height = 40,
#       dpi=600)


#print(mega_plot)

```

```{r}
multi_mod_plot <- plot_grid(boxplot_15B_150M, 
                            pisces_boxplot, 
                            labels = c('A', 'B'), 
                            ncol = 1, 
                            rel_heights = c(1.1, 1))

ggsave(multi_mod_plot, 
       filename = "multi_mod_plot.png",
       path = here("figs"),
       width = 5,
       height = 8,
       dpi=600)

multi_mod_plot

```


```{r}

# mutate df so that it is in the correct form
# use code similar to mega plot above to do all the compression methods
# use cowplot to combine them all

supp_data_mutated = data %>%
  group_by(Dataset, Compression_methd) %>%
  summarize(mean_rho_score = mean(rho_score_test, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = Compression_methd, values_from = mean_rho_score)

```

```{r}
#"pca1-2", "mean"
methods_no_mean <- c("bos", "iDCT", "maxPool", "pca1", "pca2", "rbf1", "rbf2", "sigmoid1", "sigmoid2")

scatter_plots_list <- list()

for(method in methods_no_mean){

  if(method == 'iDCT'){
    dot_color <- '#D55E00'
  } else{
  dot_color = 'black'}
  
  
  plot <- supp_data_mutated %>%
    ggplot(aes_string(x = "mean", y = method)) + 
    geom_point(size = 1, color = dot_color) +
    scale_x_continuous(limits = c(0, 1)) +
    scale_y_continuous(limits = c(0, 1)) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = '#0072B2') +
    labs(x = "mean", y = method) +
    theme_minimal_grid(12, rel_small = 1) +
    theme(
      panel.background = element_rect(fill = "white", colour = "white"),
      plot.background = element_rect(fill = "white", colour = "white"),
      legend.position = "none",
      panel.border = element_rect(color = "black", fill = NA, size = .5),
      axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
      plot.margin = margin(8, 8, 8, 8)
    )
  
  scatter_plots_list <- c(scatter_plots_list, list(plot))

}

```


```{r}

final_methods_plot <- plot_grid(plotlist = scatter_plots_list)

ggsave(final_methods_plot, 
       filename = "final_methods_plot.png",
       path = here("figs"),
       width = 9,
       height = 9,
       dpi=600)

final_methods_plot
```
```{r}
exclude_datasets <- c('F freq', 'M freq', 'C freq', 'D freq', 'Y freq', 'V freq', 'W freq', 'G freq', 'Q freq', 'S freq', 'P freq', 'H freq', 'T freq')
supp_pisces_mutated = pisces_data %>%
  group_by(Dataset, Compression_methd) %>%
  summarize(mean_rho_score = mean(rho_score_test, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = Compression_methd, values_from = mean_rho_score)

supp_pisces_mutated <- filter(supp_pisces_mutated, !(Dataset %in% exclude_datasets))

methods_no_mean <- c("bos", "iDCT", "maxPool", "pca1", "pca2", "rbf1", "rbf2", "sigmoid1", "sigmoid2")

pisces_scatter_plots_list <- list()

for(method in methods_no_mean){

  if(method == 'iDCT'){
    dot_color <- '#D55E00'
  } else{
  dot_color = 'black'}
  
  
  plot <- supp_pisces_mutated %>%
    ggplot(aes_string(x = "mean", y = method)) + 
    geom_point(size = 1, color = dot_color) +
    scale_x_continuous(limits = c(0, 1)) +
    scale_y_continuous(limits = c(0, 1)) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = '#0072B2') +
    labs(x = "mean", y = method) +
    theme_minimal_grid(12, rel_small = 1) +
    theme(
      panel.background = element_rect(fill = "white", colour = "white"),
      plot.background = element_rect(fill = "white", colour = "white"),
      legend.position = "none",
      panel.border = element_rect(color = "black", fill = NA, size = .5),
      axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
      plot.margin = margin(8, 8, 8, 8)
    )
  
  pisces_scatter_plots_list <- c(pisces_scatter_plots_list, list(plot))

}



final_methods_pisces <- plot_grid(plotlist = pisces_scatter_plots_list)

ggsave(final_methods_pisces, 
       filename = "final_methods_pisces.png",
       path = here("figs"),
       width = 9,
       height = 9,
       dpi=600)

final_methods_pisces



```
