---
title: "stats_plots"
author: "Luiz and Morgan"
date: "2024-06-08"
output: html_document
---

# Loading libraries
```{r}
library(here)
library(lme4)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(multcomp)
library(broom)
library(viridis)
library(Matrix)
# for later plotting
library(cowplot)
library(scales)


```





# DMS Data preprocessing
```{r}
#data <- read.csv(here("results/summary_results_DMS_esm2_150M_lassoCV.csv"))
#data <- read.csv(here("results/summary_DMS_all_LassoCV_esm2_150M_all_methods.csv"))
data <- read.csv(here('results/summary_DMS_all_esm2_150M_all_methods.csv'))
data <- dplyr::select(data, Dataset, Compression_method, Fold, R2_score_test, rho_score_test)
#data <- filter(data, Dataset != "HIS7 YEAST")
#data <- filter(data, Compression_methd != "pca1-2")

data

# Convert categorical variables to factors and releveling the mean to be the reference group
data$Compression_method <- factor(data$Compression_method)
data$Compression_method <- relevel(data$Compression_method, ref = "mean")
data$Dataset <- factor(data$Dataset)
data$Fold <- factor(data$Fold)
data
```

```{r}

#data <- data %>%
#  mutate(Dataset = case_when(
#     dataset == "HG_FLU_Bloom2016" ~ "New_A",
#     dataset == "BLAT_ECOLX_Ostermeier2014" ~ "New_B",
#     dataset == "RL401_YEAST_Bolon2014" ~ "New_C",
#     dataset == "PABP_YEAST_Fields2013_doubles" ~ "New_C",
#     dataset == "B3VI55_LIPST_Whitehead2015" ~ "New_C",
#     dataset == "TIM_THETH" ~ "New_C",
#     dataset == "CALM1_HUMAN_Roth2017" ~ "New_C",
#     dataset == "parEparD_Laub2015_all" ~ "New_C",
#     dataset == "BF520_env_Bloom2018" ~ "New_C",
#     dataset == "a" ~ "New_C",
#     dataset == "a" ~ "New_C",
#     dataset == "a" ~ "New_C",
#     
#     old_names = ['',
#        '', '',
#        '', '', '', 'BF520_env_Bloom2018',
#        'UBC9_HUMAN_Roth2017', 'DLG4_RAT_Ranganathan2012',
#        'BRCA1_HUMAN_RING', 'TPMT_HUMAN_Fowler2018',
#        'MTH3_HAEAESTABILIZED_Tawfik2015', 'HSP82_YEAST_Bolon2016',
#        'MK01_HUMAN_Johannessen', 'PTEN_HUMAN_Fowler2018',
#        'BG505_env_Bloom2018', 'BLAT_ECOLX_Tenaillon2013', 'TIM_SULSO',
#        'B3VI55_LIPSTSTABLE', 'RL401_YEAST_Bolon2013',
#        'PABP_YEAST_Fields2013_singles', 'BLAT_ECOLX_Ranganathan2015',
#        'RL401_YEAST_Fraser2016', 'TIM_THEMA', 'AMIE_PSEAE_Whitehead',
#        'BG_STRSQ_hmmerbit', 'GAL4_YEAST_Shendure2015',
#        'BLAT_ECOLX_Palzkill2012', 'SUMO1_HUMAN_Roth2017',
#        'RASH_HUMAN_Kuriyan', 'YAP1_HUMAN_Fields2012_singles',
#        'KKA2_KLEPN_Mikkelsen2014', 'TPK1_HUMAN_Roth2017',
#        'PA_FLU_Sun2015', 'IF1_ECOLI']
# new_names = ['HG FLU', 'BLAT ECOLX 2014', 'RL401 2014',
#        'PABP doubles', 'B3VI55 LIPST',
#        'TIM THETH', 'CALM1 HUMAN', 'parEparD all',
#        'BF520 env', 'UBC9 HUMAN', 'DLG4 RAT',
#        'BRCA1 RING', 'TPMT HUMAN',
#        'MTH3 HAEAESTABILIZED', 'HSP82 YEAST',
#        'MK01 HUMAN', 'PTEN HUMAN',
#        'BG505 env', 'BLAT ECOLX 2013', 'TIM SULSO',
#        'B3VI55 LIPSTSTABLE', 'RL401 2013',
#        'PABP singles', 'BLAT ECOLX 2015',
#        'RL401 2016', 'TIM THEMA', 'AMIE PSEAE',
#        'BG STRSQ', 'GAL4 YEAST',
#        'BLAT ECOLX 2012', 'SUMO1 HUMAN',
#        'RASH HUMAN', 'YAP1 singles',
#        'KKA2 KLEPN', 'TPK1 HUMAN',
#        'PA FLU', 'IF1 ECOLI']
#     
#     TRUE ~ Dataset  # Default case if no match
#   ))

```


# DMS Fitting the lme4 model

Dependent Variable: The dependent variable (response). Here is R2_score_test.       

Fixed Effect: The predictor variables (fixed effects) can be numeric or categorical. Categorical variables should be factors.   
'Compression_methd' is included as a fixed effect to see how different compression methods influence the R2_score_test.     

Random Effects: The grouping variables (random effects) should be factors. In here are Dataset and Fold.   
Both Dataset and Fold are included as random effects to account for variability across datasets and cross-validation folds.  

```{r}
model <- lmer(R2_score_test ~ Compression_method + (1 | Dataset) + (1|Fold), data=data)
#model <- lmer(R2_score_test ~ Compression_methd + (1 | Dataset), data=data)
########model <- lmer(rho_score_test ~ Compression_methd + (1 | Dataset) + (1|Fold), data=data)
#model <- lmer(rho_score_test ~ Compression_methd + (1 | Dataset), data=data)
summary(model)



# if you get this error:
# Error in initializePtr() : 
#  function 'chm_factor_ldetL2' not provided by package 'Matrix'

#visit: https://www.bioconductor.org/packages/release/bioc/vignettes/dreamlet/inst/doc/errors.html
# look at 'Errors with random effects' section
```



```{r}
#glht_results <- summary(glht(model, linfct=c('Compression_methdbos=0',
#                             'Compression_methdiDCT=0',
#                              'Compression_methdmaxPool=0',
#                              'Compression_methdpca1=0',
#                              '`Compression_methdpca1-2`=0',
#                              'Compression_methdpca2=0',
#                              'Compression_methdrbf1=0',
#                              'Compression_methdrbf2=0',
#                              'Compression_methdsigmoid1=0',
#                              'Compression_methdsigmoid2=0')))



glht_results <- summary(glht(model, linfct=c(
                              'Compression_methodbos=0',
                              'Compression_methodiDCT1=0',
                              'Compression_methodiDCT2=0',
                              'Compression_methodiDCT3=0',
                              'Compression_methodiDCT4=0',
                              'Compression_methodiDCT5=0',
                              'Compression_methodmaxPool=0',
                              'Compression_methodpca1=0',
###                              '`Compression_methodpca1-2`=0',
                              'Compression_methodpca2=0',
                              'Compression_methodrbf1=0',
                              'Compression_methodrbf2=0',
                              'Compression_methodsigmoid1=0',
                              'Compression_methodsigmoid2=0')))

glht_results 
```


```{r}
#summary(glht(model, linfct=mcp(Compression_method="Tukey")))
```


## Interpretation


The intercept in a regression model represents the expected value of the dependent variable (in this case, R2_score_test) 
when all predictor variables are set to zero. It's the baseline value from which other effects are measured.


Fixed effects are the estimated coefficients for the predictor variables in the model. These effects are assumed to be the 
same across all groups in the dataset. In your model, Compression_methd is treated as a fixed effect, meaning its impact on 
R2_score_test is consistent across all datasets.

Random effects account for variability within the data that is not explained by the fixed effects. They allow the model to 
consider differences across groups (e.g., different datasets or cross-validation folds). For example, if some datasets inherently
have higher or lower R2 scores, this variability is captured by including Dataset as a random effect.

Residuals are the differences between the observed values and the values predicted by the model. They represent the "error" 
or "noise" in the model. Residual analysis helps to check the assumptions of the model (e.g., normality and homoscedasticity 
of residuals).



# DMS Evaluating individual datasets

```{r}
# Tidy the results
tidy_glht <- tidy(glht_results)
#tidy_glht<- tidy_glht %>% dplyr::filter(contrast != #'Compression_methodiDCT')

ci <- tidy(confint(glht_results)) %>% dplyr::select("contrast", "conf.high", "conf.low")

res_glht = merge(tidy_glht, ci, by = 'contrast')



res_glht$contrast <- gsub("Compression_method", "", res_glht$contrast)

#res_glht$contrast <- gsub("iDCT2", "iDCT", res_glht$contrast)


# Determine significance levels
res_glht$signif <- ifelse(res_glht$adj.p.value < 0.001, "***",
                 ifelse(res_glht$adj.p.value < 0.01, "**",
                 ifelse(res_glht$adj.p.value < 0.05, "*", "")))



res_glht
```



# Figure 2A: DMS Plotting lmer
```{r}
#, fig.width=2.5, fig.height=6, out.width = 100%, out.height = 100%


res_glht <- res_glht %>%
  mutate(contrast = case_when(
    contrast == "bos" ~ "BOS",
    contrast == "maxPool" ~ "Max Pooling",
    TRUE ~ contrast
  ))

final_plot <- res_glht %>%
  ggplot(aes(y = fct_reorder(contrast, estimate), 
             x = estimate, 
             #color = contrast
             )) +
  geom_point() +
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0.2) +
  theme_minimal() +
  labs(
       y = "Compression Method",
       x = expression(R^2 * " Difference from Mean Pooling")
       ) +
  geom_vline(xintercept = 0, linetype = "dotted", color = '#000000', linewidth = 1) +

  scale_x_continuous(limit = c(-.25, 0.05),
  ) + 
  theme_minimal_vgrid(12, rel_small = 1) +  
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.background = element_rect(fill = "white", colour = "white"),
    axis.text.x=element_text(size=12),
    axis.text.y=element_text(size=10),

    panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
    axis.line = element_blank(),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.y = element_line(color = "black"),
    plot.margin = margin(10,10,0,10)
  ) +
  ggtitle("DMS")

 #ggsave(final_plot, 
 #       filename = "fig2_iDCT_DMS_v12.png",
 #       path = here("figures"),
 #       width = 6,
 #       height = 6,
 #       dpi=600)


final_plot
  
```



# Fig 3A DMS multi boxplot 
```{r}

multi_mod_DMS <- read.csv(here("results/lassoCV/DMS/DMS_all_multi_model_metadata.csv"))

multi_mod_DMS <- multi_mod_DMS %>%
  mutate(Model = case_when(
    Model == "esm1v" ~ "ESM1v",
    Model == "esm2" ~ "ESM2",
    Model == "esmc" ~ "ESMC",
    Model == "amplify" ~ "Amplify"
  )) %>%
  mutate(
    parameters = case_when(
      parameters == 6.5e8 & Model == "ESM2" ~ 7.8e8,
      parameters == 6e8 & Model == "ESMC" ~ 5.5e8,
      TRUE ~ parameters
    )
  ) 

#exlude due to sequences too long for esm1v, need to make sup figure
#exclude_data <- c("BRCA1 RING", "UBE4B singles", "BRCA1 BRCT", "POLG Sun2014")
exclude_data <-  c('BRCA1_HUMAN_RING','UBE4B_MOUSE_Klevit2013_singles', 'BRCA1_HUMAN_BRCT', 'POLG_HCVJF_Sun2014')

grouped_multi_mod_DMS <- multi_mod_DMS %>%
  filter(!Dataset %in% exclude_data) %>%
  filter(Compression_method %in% c('mean')) %>%
  group_by(Dataset, Model, parameters) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE),
   
  ) %>%
  mutate(Model = factor(Model, levels = c("ESM1v", "ESM2", "ESMC", "Amplify"))) %>%
  ungroup()



data_medians <- grouped_multi_mod_DMS %>%
  group_by(Model, parameters) %>%
  summarize(
    median_R2 = median(mean_score)
  )



# need to make an order for the x axis
#grouped_multi_mod_DMS$Model <- factor(grouped_multi_mod_DMS$Model, levels = c("ESM1v 650M", "ESM2 8M", "ESM2 35M", "ESM2 150M", "ESM2 650M", "ESM2 3B", "ESM2 15B"))


```


```{r}

# color_dict <- c(
#   "ESM1v" = "#ff7f0e",
#   "ESM2" = "#1f77b4",
#   "ESMC" = "#2ca02c",
#   "Amplify" = "#FFFF00"
# )



#     scale_color_manual(
#       values = colorspace::darken(c(ESM1v = "#000000", ESM2 = "#56B4E9",
#                  ESMC = "#009E73", Amplify = "#E69F00"), .2)
#     ) +
#     scale_fill_manual(
#       values = c(ESM1v = "#00000080", ESM2 = "#56B4E980",
#                  ESMC = "#009E7380", Amplify = "#E69F0080")
#     ) +



DMS_all_boxplot <- grouped_multi_mod_DMS %>%
  ggplot(aes(
    x = parameters, 
    y = mean_score, 
    group = interaction(Model, parameters), 
    color = Model,
    fill = Model
    )) +
    geom_line(
      data = data_medians,
      aes(parameters, median_R2, color = Model),
      inherit.aes = FALSE
    ) +
    geom_boxplot()+
    scale_x_log10(trans = scales::log_trans(),
                     breaks = scales::log_breaks(),
                     labels = trans_format("log10", math_format(10^.x))) +
    
    #scale_color_manual(values = color_dict) +
    scale_color_manual(
      values = colorspace::darken(c(ESM1v = "#000000", ESM2 = "#4292C6",
                 ESMC = "#228C22", Amplify = "#ff7f0e"), .2)
    ) +
    scale_fill_manual(
      values = c(ESM1v = "#00000080", ESM2 = "#9ECAE1",
                 ESMC = "#5ad75a", Amplify = "#ffb16c")
    ) +
    labs(x = "", 
         y = expression(paste("Cross Validation ", R^2)), 
         #title = ""
         color = ""
         ) +
  guides(
    color = guide_legend(title = "Model"),
    fill = guide_legend(title = "Model")
  ) +
    theme_minimal_hgrid(12, rel_small = 1)+
    theme(
        legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10))
  
DMS_all_boxplot
 
# ggsave(DMS_all_boxplot, 
#       filename = "DMS_all_boxplot.png",
#        path = here('figs'),
#        width = 8,
#        height = 4,
#       dpi=600)      



```




# Supp 3 Excluded DMS MultiMod


```{r}
data_with_size <- read.csv(here('results/summary_DMS_all_multi_model.csv'))

data_with_size <- data_with_size %>%
  group_by(Dataset, Model) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE),
    dataset_size = median(get('dataset_size')),
    group = unique(group)[1],
    prot_length = median(get('prot_length'))
  ) %>%
  ungroup()

data_with_size <- data_with_size %>%
  mutate(Model = case_when(
    Model == "esm1v_650M" ~ "ESM1v 650M",
    Model == "esm2_8M" ~ "ESM2 8M",
    Model == "esm2_35M" ~ "ESM2 35M",
    Model == "esm2_150M_all" ~ "ESM2 150M",
    Model == "esm2_150M" ~ "ESM2 150M",
    Model == "esm2_650M" ~ "ESM2 650M",
    Model == "esm2_3B" ~ "ESM2 3B",
    Model == "esm2_15B" ~ "ESM2 15B"
  ))

data_with_size$Model <- factor(data_with_size$Model, levels = c('ESM1v 650M', 'ESM2 8M', 'ESM2 35M', 'ESM2 150M', 'ESM2 650M', 'ESM2 3B', 'ESM2 15B'))

```


```{r}

#exclude_data <- c("BRCA1 RING", "UBE4B_MOUSE_Klevit2013_singles", "BRCA1_HUMAN_BRCT", "POLG_HCVJF_Sun2014", "BG505 env")
  
exclude_data <- c("BRCA1 RING", "UBE4B singles", "BRCA1 BRCT", "POLG Sun2014")
#  c('BRCA1_HUMAN_RING', 'UBE4B_MOUSE_Klevit2013_singles',
#    'BRCA1_HUMAN_BRCT', 'POLG_HCVJF_Sun2014', 'BG505_env_Bloom2018')


excluded_multi_mod_DMS <- data_with_size %>%
   filter(Dataset %in% exclude_data) %>%
   ungroup()

max_len = max(excluded_multi_mod_DMS$prot_length)

```

```{r}

small_data <- c("GAL4 YEAST", "DLG4 RAT", "PABP singles", "PTEN HUMAN", "AMIE PSEAE", "TIM THEMA", "CALM1 HUMAN")

small_multi_mod_DMS <- data_with_size %>%
  filter(Dataset %in% small_data) %>%
  filter(!Model %in% c("ESM1v 650M")) %>%

  ungroup()



min_len = min(small_multi_mod_DMS$prot_length)

```




```{r}

excluded_DMS_gradient_plot <- excluded_multi_mod_DMS %>%
  #filter(Compression_method %in% c('mean')) %>%
  ggplot(aes(
    x = Model, 
    y = mean_score, 
    group = Dataset, 
    color = prot_length
    #mean_score
    )) +
    geom_line() +
  scale_y_continuous(limit = c(0, 0.63)) +
    geom_point(shape = 21, 
               size = 2,  
               color = "black", 
               aes(fill = prot_length), # mean_score 
               stroke = .2
               ) + 
    scale_color_viridis_c(name = "Protein Length",
                          #begin = .1, 
                          #end =1, 
                          direction=-1,
                          limit = c(min_len, max_len)) +
    scale_fill_viridis_c(#begin = .1, 
                         #end = 1, 
                         direction = -1, guide = "none",
                          limit = c(min_len, max_len)) +
    labs(x = "", 
         y = expression(R^2), 
         #title = ""
         color = ""
         ) +
    theme_minimal_hgrid(12, rel_small = 1)+
    theme(
        #legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10))
  
excluded_DMS_gradient_plot

 # ggsave(excluded_DMS_gradient_plot, 
 #       filename = "sup_excluded_DMS.png",
 #        path = here('figs'),
 #        width = 11,
 #       #6
 #        height = 4,
 #        dpi=600)      

excluded_DMS_gradient_plot
```





```{r}

small_DMS_gradient_plot <- small_multi_mod_DMS %>%
  #filter(Compression_method %in% c('mean')) %>%
  ggplot(aes(
    x = Model, 
    y = mean_score, 
    group = Dataset, 
    color = prot_length, #mean_score
    )) +
  scale_y_continuous(limit = c(0, 0.63)) +
    geom_line() +
    geom_point(shape = 21, 
               size = 2,  
               color = "black", 
               aes(fill = prot_length), #mean_score
               stroke = .2
               ) + 
    scale_color_viridis_c(name = "Protein Length",
                          #begin = .1, 
                          #end =1, 
                          direction=-1,
                          limit = c(min_len, max_len)) +
    scale_fill_viridis_c(#begin = .1, 
                         #end = 1, 
                         direction = -1, 
                         guide = "none",
                          limit = c(min_len, max_len)) +
    labs(x = "", 
         y = expression(R^2), 
         #title = ""
         color = ""
         ) +
    theme_minimal_hgrid(12, rel_small = 1)+
    theme(
        #legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10))
  
small_DMS_gradient_plot

  # ggsave(small_DMS_gradient_plot, 
  #       filename = "small_DMS_gradient_plot.png",
  #        path = here('figs'),
  #        width = 12,
  #       #6
  #        height = 4,
  #        dpi=600)      

small_DMS_gradient_plot
```

```{r}
gradient_plots <- plot_grid(excluded_DMS_gradient_plot, 
                        small_DMS_gradient_plot,
                        labels = c('A', 'B'), 
                        label_size = 12, 
                        rel_heights = c(1, 1),
                        ncol = 1)

# ggsave(gradient_plots,
#        filename = "sup_gradient_plots_prot_length.png",
#        path = here("figs"),
#        width = 9,
#        height = 8,
#        dpi=600)

gradient_plots

```




# Figure 5, sup 8,9 - CURRENTLY EDITING


```{r}

data_with_size <- read.csv(here('results/lassoCV/DMS/DMS_all_multi_model_metadata.csv'))

data_with_size <- data_with_size %>%
  filter(Compression_method == "mean") %>%
  group_by(Dataset, Model, ModelSize) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE),
    dataset_size = median(get('dataset_size')),
    group = unique(group)[1],
    prot_length = median(get('prot_length'))
  ) %>%
  mutate(Model = case_when(
    Model == "esm1v" ~ "ESM1v",
    Model == "esm2" ~ "ESM2",
    Model == "esmc" ~ "ESMC",
    Model == "amplify" ~ "Amplify"
  ))%>%
  mutate(Model = factor(Model, levels = c("ESM1v", "ESM2", "ESMC", "Amplify"))) %>%
  ungroup()


#data_with_size$Model <- factor(data_with_size$Model, levels = c('ESM1v 650M', 'ESM2 8M', 'ESM2 35M', 'ESM2 150M', 'ESM2 650M', 'ESM2 3B', 'ESM2 15B'))
data_with_size$group <- factor(data_with_size$group, levels = c("Growth", "Viral replication", "Enzyme function", "Other", "Peptide binding", "Protein stability"))

data_with_size$ModelSize <- factor(data_with_size$ModelSize, levels = c("8M", "35M", "120M", "150M", "350M", "650M","3B", "15B", "300M", "600M"))


```


# Supp 8
```{r}
#ESM1v 650M
model_ESM1v_650M <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "ESM1v" & ModelSize == "650M"))
r_squared_ESM1v_650M <- summary(model_ESM1v_650M)$r.squared
label_ESM1v_650M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_ESM1v_650M)))


# ESM2 8M
model_8M <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "ESM2" & ModelSize == "8M"))
r_squared_8M <- summary(model_8M)$r.squared
label_8M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_8M)))


#ESM2 35M
model_35M <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "ESM2" & ModelSize == "35M"))
r_squared_35M <- summary(model_35M)$r.squared
label_35M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_35M)))

#ESM2 150M
model_150M <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "ESM2" & ModelSize == "150M"))
r_squared_150M <- summary(model_150M)$r.squared
label_150M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_150M)))


#ESM2 650M
model_650M <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "ESM2" & ModelSize == "650M"))
r_squared_650M <- summary(model_650M)$r.squared
label_650M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_650M)))

#ESM2 3B
model_3B <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "ESM2" & ModelSize == "3B"))
r_squared_3B <- summary(model_3B)$r.squared
label_3B <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_3B)))


#ESM2 15B
model_15B <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "ESM2" & ModelSize == "15B"))
r_squared_15B <- summary(model_15B)$r.squared
label_15B <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_15B)))


#ESMC 300M
model_C300M <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "ESMC" & ModelSize == "300M"))
r_squared_C300M <- summary(model_C300M)$r.squared
label_C300M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_C300M)))


#ESMC 600M
model_C600M <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "ESMC" & ModelSize == "600M"))
r_squared_C600M <- summary(model_C600M)$r.squared
label_C600M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_C600M)))



#Amplify 120M 
model_A120M <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "Amplify" & ModelSize == "120M"))
r_squared_A120M <- summary(model_A120M)$r.squared
label_A120M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_A120M)))

#Amplify 350M
model_A350M <- lm(mean_score ~ log(dataset_size), data = subset(data_with_size, Model == "Amplify" & ModelSize == "350M"))
r_squared_A350M <- summary(model_A350M)$r.squared
label_A350M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", r_squared_A350M)))




data_text <- data.frame(
  labels = I(list(label_ESM1v_650M, label_8M, label_35M, label_150M, label_650M, label_3B, label_15B, label_C300M, label_C600M, label_A120M, label_A350M)),
  Model = c("ESM1v", "ESM2", "ESM2", "ESM2", "ESM2","ESM2", "ESM2", "ESMC", "ESMC", "Amplify", "Amplify"),
  ModelSize = c("650M", "8M", "35M", "150M", "650M","3B", "15B", "300M", "600M", "120M", "350M"),
  x = c(1150, 3700, 3700, 3700, 3700, 3700, 3700, 1200, 1200, 1200, 1200),
  y = c(.75, .75, .75, .75, .75, .75, .75, .75, .83, .75, .75)
)



data_text$ModelSize <- factor(data_text$ModelSize, levels = c("8M", "35M", "120M", "150M", "350M", "650M","3B", "15B", "300M", "600M"))



print(data_text)
```



```{r}

# FOR SUP 8

label_function <- function(x) {
    ifelse(log10(x) %% 1 == 0, parse(text = paste0("10^", log10(x))), "")
}


plot_param <- data_with_size %>%
  filter(Model == 'ESM2') %>%
    ggplot(aes(
      x = dataset_size, 
      y = mean_score,
      color = group
      )) +

  scale_x_log10(labels = label_function)+



  geom_smooth(
      aes(group = Model),
      method = 'lm', 
      color = "black",      
      se = TRUE, 
      fill = "gray",
      size = 0.3
    ) +
    geom_point(alpha = 1, size = .9
              ) +
    
    geom_errorbar(
      aes(
        ymin = mean_score - std_score, 
        ymax = mean_score + std_score), 
      alpha = .7
  
      )+
  
 
    labs(x = "Sample Size", 
         y = expression(paste("Cross Validation ", R^2))
         ) +
  guides(color = guide_legend(title = NULL))  +
    theme_minimal_grid(12, rel_small = 1)+
    theme(
        #legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10)
        )+
  
    geom_text(
        data = filter(data_text, Model == "ESM2"),
        mapping = aes(x = x, y = y, label = labels),
        color = "black",
        parse=TRUE,

        )+
  facet_wrap(~ ModelSize,scales = "free_x")
    


 # ggsave(plot_param,
 #        filename = "plot_param.png",
 #        path = here("figs"),
 #        width = 8.5,
 #        height = 5,
 #        dpi=600)

plot_param 


```

# Supp 9

```{r}

#ESM1v 650M
pmodel_ESM1v_650M <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "ESM1v" & ModelSize == "650M"))
pr_squared_ESM1v_650M <- summary(pmodel_ESM1v_650M)$r.squared
plabel_ESM1v_650M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_ESM1v_650M)))

# ESM2 8M
pmodel_8M <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "ESM2" & ModelSize == "8M"))
pr_squared_8M <- summary(pmodel_8M)$r.squared
plabel_8M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_8M)))

#ESM2 35M
pmodel_35M <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "ESM2" & ModelSize == "35M"))
pr_squared_35M <- summary(pmodel_35M)$r.squared
plabel_35M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_35M)))


#ESM2 150M
pmodel_150M <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "ESM2" & ModelSize == "150M"))
pr_squared_150M <- summary(pmodel_150M)$r.squared
plabel_150M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_150M)))


#ESM2 650M
pmodel_650M <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "ESM2" & ModelSize == "650M"))
pr_squared_650M <- summary(pmodel_650M)$r.squared
plabel_650M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_650M)))

#ESM2 3B
pmodel_3B <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "ESM2" & ModelSize == "3B"))
pr_squared_3B <- summary(pmodel_3B)$r.squared
plabel_3B <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_3B)))


#ESM2 15B
pmodel_15B <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "ESM2" & ModelSize == "15B"))
pr_squared_15B <- summary(pmodel_15B)$r.squared
plabel_15B <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_15B)))

#ESMC 300M
pmodel_C300M <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "ESMC" & ModelSize == "300M"))
pr_squared_C300M <- summary(pmodel_C300M)$r.squared
plabel_C300M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_C300M)))

#ESMC 600M
pmodel_C600M <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "ESMC" & ModelSize == "600M"))
pr_squared_C600M <- summary(pmodel_C600M)$r.squared
#plabel_C600M <- bquote(R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_C600M)))
plabel_C600M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_C600M)))

#Amplify 120M 
pmodel_A120M <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "Amplify" & ModelSize == "120M"))
pr_squared_A120M <- summary(pmodel_A120M)$r.squared
plabel_A120M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_A120M)))

#Amplify 350M
pmodel_A350M <- lm(mean_score ~ log(prot_length), data = subset(data_with_size, Model == "Amplify" & ModelSize == "350M"))
pr_squared_A350M <- summary(pmodel_A350M)$r.squared
plabel_A350M <- bquote("Regression " ~ R^2 ~ ": " ~ .(sprintf("%.3f", pr_squared_A350M)))




prot_data_text <- data.frame(
  #labels = c(label_150M, label_650M, label_15B),
  labels = I(list(plabel_ESM1v_650M, plabel_8M, plabel_35M, plabel_150M, plabel_650M, plabel_3B, plabel_15B, plabel_C300M, plabel_C600M, plabel_A120M, plabel_A350M)),
  Model = c("ESM1v", "ESM2", "ESM2", "ESM2", "ESM2","ESM2", "ESM2", "ESMC", "ESMC", "Amplify", "Amplify"),
  ModelSize = c("650M", "8M", "35M", "150M", "650M","3B", "15B", "300M", "600M", "120M", "350M"),
  x = c(130, 460, 460, 460, 460, 460, 460, 180, 180, 180, 180),
  y = c(.72, .75, .75, .75, .75, .75, .75, .76, .83, .76, .76)
)


prot_data_text$ModelSize <- factor(prot_data_text$ModelSize, levels = c("8M", "35M", "120M", "150M", "350M", "650M","3B", "15B", "300M", "600M"))

print(prot_data_text)

```


```{r}

# FOR SUP 9

label_function <- function(x) {
    ifelse(log10(x) %% 1 == 0, parse(text = paste0("10^", log10(x))), "")
}

data_with_size$ModelSize <- factor(data_with_size$ModelSize, levels = c("8M", "35M", "120M", "150M", "350M", "650M","3B", "15B", "300M", "600M"))

sup9_prot_length <- data_with_size %>%
  filter(Model == 'ESM2') %>%
    ggplot(aes(
      x = prot_length, 
      y = mean_score,
      color = group
      )) +
  scale_x_log10()+


  geom_smooth(
      aes(group = Model),
      method = 'lm', 
      #formula = y ~ log(x), 
      color = "black",      
      se = TRUE, 
      fill = "gray",
      size = 0.3
    ) +
    geom_point(alpha = 1, size = .9
              ) +
    
    geom_errorbar(
      aes(
        ymin = mean_score - std_score, 
        ymax = mean_score + std_score), 
      alpha = .7
  
      )+

    
    labs(x = "Protein Length", 
         y = expression(paste("Cross Validation ", R^2))
         #title = param_vec[1]
         #title = cat("ESM2", param),
         #color = ""
         ) +
  guides(color = guide_legend(title = NULL))  +
    theme_minimal_grid(12, rel_small = 1)+
    theme(
        #legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10)
        )+
  
    geom_text(
        data = filter(prot_data_text, Model == "ESM2"),
        mapping = aes(x = x, y = y, label = labels),
        color = "black",
        parse=TRUE,

        )+
  facet_wrap(~ ModelSize, scales = "free_x")
    


 # ggsave(sup9_prot_length,
 #        filename = "sup9.png",
 #        path = here("figs"),
 #        width = 8.5,
 #        height = 5,
 #        dpi=600)

sup9_prot_length 


```

# Fig 5
```{r}

label_function <- function(x) {
    ifelse(log10(x) %% 1 == 0, parse(text = paste0("10^", log10(x))), "")
}

fig_5_datasize <- data_with_size %>%
  filter(Model == 'ESMC' & ModelSize == '600M') %>%
    ggplot(aes(
      x = dataset_size, 
      y = mean_score,
      color = group
      )) +
    

    
  
  geom_smooth(
      #aes(group = Model),
      method = 'lm', 
      #formula = y ~ log10(x), 
      color = "black",      
      se = TRUE, 
      fill = "gray",
      size = 0.3
    ) +
  
  scale_x_log10()+


  
    scale_y_continuous(limits = c(0, 0.85))+
  
    geom_point(alpha = 1, size = 2
              ) +
    
    geom_errorbar(
      aes(
        ymin = mean_score - std_score, 
        ymax = mean_score + std_score), 
      alpha = .8,
      size = .6
      )+
    labs(x = "Sample Size", 
         y = expression(paste("Cross Validation ", R^2))
           #expression(paste(R^2)),

         ) +
  guides(color = guide_legend(title = NULL))  +
    theme_minimal_grid(12, rel_small = 1)+
    theme(
        legend.position = "none",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10)
        )+
  
    geom_text(
        data = filter(data_text, Model == "ESMC 600M"),
        mapping = aes(x = x, y = y, label = labels),
        color = "black",
        parse=TRUE,
        
        )

fig_5_datasize

# 
# ggsave(fig_5_datasize,
#        filename = "fig_5_datasize.png",
#        path = here("figs"),
#        width = 8,
#        height = 5,
#        dpi=600)

```


```{r}
#fig 5 second part with protein length

label_function <- function(x) {
    ifelse(log10(x) %% 1 == 0, trans_format("log10", math_format(10^.x))(x), "")
  }


fig5_protlen <- data_with_size %>%
  filter(Model == 'ESMC' & ModelSize == '600M') %>%
    ggplot(aes(
      x = prot_length, 
      y = mean_score,
      color = group
      )) +
  
  scale_x_log10()+


    scale_y_continuous(limits = c(0, 0.85))+

  geom_smooth(
      aes(group = Model),
      method = 'lm', 
      #formula = y ~ log(x), 
      color = "black",      
      se = TRUE, 
      fill = "gray",
      size = 0.3
    ) +
    geom_point(alpha = 1, size = 2
              ) +
    
    geom_errorbar(
      aes(
        ymin = mean_score - std_score, 
        ymax = mean_score + std_score), 
      alpha = .8,
      size = .6
  
      )+

    labs(x = "Protein Length", 
         y = NULL,
         ) +
  guides(color = guide_legend(title = NULL))  +
    theme_minimal_grid(12, rel_small = 1)+
    theme(
        legend.position = "right",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 20, 0, 0)
        )+
  
    geom_text(
        data = filter(prot_data_text, Model == "ESMC 600M"),
        mapping = aes(x = x, y = y, label = labels),
        color = "black",
        parse=TRUE,

        )


# ggsave(fig5_protlen,
#        filename = "fig5_protlen.png",
#        path = here("figs"),
#        width = 8,
#        height = 5,
#        dpi=600)

fig5_protlen 

```

```{r}
#fig5 assembly
fig5_assembled <- plot_grid(fig_5_datasize,
                  fig5_protlen,
                  labels = c('A', 'B'), 
                  label_size = 12, 
                  rel_widths = c(1, 1.35)
                  )

# ggsave(fig5_assembled,
#        filename = "fig5_assembled.png",
#        path = here("figs"),
#        width = 10,
#        height = 4,
#        dpi=600)

fig5_assembled

```











# Pisces Data Preprocessing
```{r}
pisces_data <- read.csv(here('results/summary_PISCES_esm2_150M_all_methods.csv'))
#'Pisces_summary.csv'
pisces_data <- dplyr::select(pisces_data, c('Dataset', 'Compression_method', 'Fold', 'R2_score_test', 'rho_score_test'))

#pisces_data <- filter(pisces_data, !Dataset %in% c('W freq', 'M freq','V freq', 'Y freq', 'D freq','C freq', 'F freq'))
#pisces_data <- filter(pisces_data, !Compression_method %in% c('pca1-2'))

pisces_data

# Convert categorical variables to factors and releveling the mean to be the reference group
pisces_data$Compression_method <- factor(pisces_data$Compression_method)
pisces_data$Compression_method <- relevel(pisces_data$Compression_method, ref = "mean")
pisces_data$Dataset <- factor(pisces_data$Dataset)
pisces_data$Fold <- factor(pisces_data$Fold)

pisces_data

```


```{r}
pisces_model <- lmer(R2_score_test ~ Compression_method + (1 | Dataset) + (1|Fold), data=pisces_data)
summary(pisces_model)
```

```{r}
pisces_glht_results <- summary(glht(pisces_model, linfct=c('Compression_methodbos=0',
                             'Compression_methodiDCT1=0',
                             'Compression_methodiDCT2=0',
                             'Compression_methodiDCT3=0',
                             'Compression_methodiDCT4=0',
                             'Compression_methodiDCT5=0',
                              'Compression_methodmaxPool=0',
                              'Compression_methodpca1=0',
###                              '`Compression_methodpca1-2`=0',
                              'Compression_methodpca2=0',
                              'Compression_methodrbf1=0',
                              'Compression_methodrbf2=0',
                              'Compression_methodsigmoid1=0',
                              'Compression_methodsigmoid2=0')))

pisces_glht_results 

```

```{r}
# Tidy the results
pisces_tidy_glht <- tidy(pisces_glht_results)

pisces_ci <- tidy(confint(pisces_glht_results)) %>% dplyr::select("contrast", "conf.high", "conf.low")

pisces_res_glht = merge(pisces_tidy_glht, pisces_ci, by = 'contrast')



pisces_res_glht$contrast <- gsub("Compression_method", "", pisces_res_glht$contrast)


# Determine significance levels
pisces_res_glht$signif <- ifelse(pisces_res_glht$adj.p.value < 0.001, "***",
                 ifelse(pisces_res_glht$adj.p.value < 0.01, "**",
                 ifelse(pisces_res_glht$adj.p.value < 0.05, "*", "")))



pisces_res_glht
```


# Figure 2B: Pisces lmer
```{r, fig.width=4, fig.height=8, out.width = 100%, out.height = 100%}

pisces_res_glht <- pisces_res_glht %>%
  mutate(contrast = case_when(
    contrast == "bos" ~ "BOS",
    contrast == "maxPool" ~ "Max Pooling",
    TRUE ~ contrast
  ))


pisces_plot <- pisces_res_glht %>%
  ggplot(aes(
      y = fct_reorder(contrast, estimate), 
      x = estimate, 
      #color = contrast
      )) +
  geom_point() +
  geom_errorbar(aes(xmin = conf.low, 
                    xmax = conf.high), 
                width = 0.2) +
  theme_minimal() +
  labs(
       y = NULL,
       x = expression(R^2 * " Difference from Mean Pooling"),
       ) +
  geom_vline(xintercept = 0, 
             linetype = "dotted", 
             color = '#000000', 
             linewidth = 1) +

  scale_x_continuous(limit = c(-.85, 0),
                     breaks = seq(-0.8, 0, by = 0.4)
                     ) + 
   theme_minimal_vgrid(12, rel_small = 1) +  
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.background = element_rect(fill = "white", colour = "white"),
    axis.text.y=element_text(size=10),

    panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
    axis.line = element_blank(),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.y = element_line(color = "black"),
    
    plot.margin = margin(10,10,0,10)
  ) +
  ggtitle("PISCES")

pisces_plot

# ggsave(pisces_plot, 
#        filename = "fig3_iDCT_pisces_v04.png",
#        path = here("figs"),
#        width = 6,
#        height = 6,
#        dpi=600)




  
```







# Figure 3B Pisces multiboxplot

```{r}
multi_mod_pisces <- read.csv(here("results/lassoCV/PISCES/PISCES_all_multi_model.csv"))


multi_mod_pisces <- multi_mod_pisces %>%
  mutate(Model = case_when(
    Model == "esm1v" ~ "ESM1v",
    Model == "esm2" ~ "ESM2",
    Model == "esmc" ~ "ESMC",
    Model == "amplify" ~ "Amplify"
  )) %>%
  mutate(
    parameters = case_when(
      parameters == 6.5e8 & Model == "ESM2" ~ 7.8e8,
      parameters == 6e8 & Model == "ESMC" ~ 5.5e8,
      TRUE ~ parameters
    )
  )


grouped_multi_mod_pisces <- multi_mod_pisces %>%
  filter(Compression_method %in% c('mean')) %>%
  group_by(Dataset, Model, parameters) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE),
   
  ) %>%
  mutate(Model = factor(Model, levels = c("ESM1v", "ESM2", "ESMC", "Amplify"))) %>%
  ungroup()



data_medians_pisces <- grouped_multi_mod_pisces %>%
  group_by(Model, parameters) %>%
  summarize(
    median_R2 = median(mean_score)
  )



```
```{r}
pisces_all_boxplot <- grouped_multi_mod_pisces %>%
  ggplot(aes(
    x = parameters, 
    y = mean_score, 
    group = interaction(Model, parameters), 
    color = Model,
    fill = Model
    )) +
    geom_line(
      data = data_medians_pisces,
      aes(parameters, median_R2, color = Model),
      inherit.aes = FALSE
    ) +
    geom_boxplot()+
    scale_x_log10(trans = scales::log_trans(),
                     breaks = scales::log_breaks(),
                     labels = trans_format("log10", math_format(10^.x))) +
    scale_color_manual(
      values = colorspace::darken(c(ESM1v = "#000000", ESM2 = "#4292C6",
                 ESMC = "#228C22", Amplify = "#ff7f0e"), .2)
    ) +
    scale_fill_manual(
      values = c(ESM1v = "#00000080", ESM2 = "#9ECAE1",
                 ESMC = "#5ad75a", Amplify = "#ffb16c")
    ) +
    labs(x = "", 
         y = expression(paste("Cross Validation ", R^2)), 
         #title = ""
         color = ""
         ) +
    theme_minimal_hgrid(12, rel_small = 1)+
    theme(
        legend.position = "none",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10))
  
pisces_all_boxplot
 
# ggsave(pisces_all_boxplot, 
#       filename = "pisces_all_boxplot.png",
#        path = here('figs'),
#        width = 8,
#        height = 4,
#       dpi=600)      



```



# Figure 4: DMS 4 set (with His7) sampling (DMS) 
```{r}
DMS_sampling <- read.csv(here('results/lassoCV_sampling/lassoCV_sampling_all_models_and_datasets.csv'))
  #read.csv(here('results/summary_DMS4_sampling.csv'))


```

```{r}
grouped_DMS_sampling <- DMS_sampling %>%
  mutate(Dataset = case_when(
  Dataset == "BLAT_ECOLX_2015" ~ "BLAT Singles",
  Dataset == "PABP_doubles" ~ "PABP Doubles",
  Dataset == "HIS7" ~ "HIS7 Multiple",
  #TRUE ~ Dataset
  )) %>%
  group_by(Dataset, Sample_size, Model, ModelSize) %>%
  filter(!Sample_size %in% c(32)) %>%
  filter(!Model %in% c("esm1v")) %>%
  summarise(
    mean_R2_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_R2_score = sd(get('R2_score_test'), na.rm = TRUE),
    mean_coeff_score = mean(get('nun_zero_coefs'), na.rm = FALSE),
    std_coeff_score = sd(get('nun_zero_coefs'), na.rm = FALSE)
  ) %>%
  mutate(Model = case_when(
    Model == "esm2" ~ "ESM2",
    Model == "esmc" ~ "ESMC",
    Model == "amplify" ~ "Amplify",
    TRUE ~ Model
  )) %>%
  ungroup()


grouped_DMS_sampling$modelname <- paste(grouped_DMS_sampling$Model, grouped_DMS_sampling$ModelSize)

grouped_DMS_sampling <- grouped_DMS_sampling %>%
  mutate(ModelSize = factor(ModelSize, levels = c("8M", "35M", "150M", "650M", "3B", "15B", "300M", "600M", "120M", "350M"))) %>%
  mutate(Dataset = factor(Dataset, levels = c("BLAT Singles", "PABP Doubles", "HIS7 Multiple"))) %>%
mutate(Model = factor(Model, levels = c("ESM2", "ESMC", "Amplify"))) #%>%
# mutate(modelname = factor(modelname, levels = c("ESM2 8M", "ESM2 35M", "ESM2 150M", "ESM2 650M", "ESM2 3B", "ESM2 15B", "ESMC 300M", "ESMC 600M", "Amplify 120M", "Amplify 350M")))



```


```{r}

#color_dict <- c("150M" = '#9ECAE1','650M' = '#4292C6', "15B" = '#254369')
# color_dict = c("ESM1v 650M" = "#D68F6B", "ESM2 8M" = "#C6DBEF", "ESM2 35M" = "#9ECAE1", "ESM2 150M" = "#6BAED6", "ESM2 650M" = "#4292C6", "ESM2 3B" = "#2171B5", "ESM2 15B" = "#084594", "ESMC 300M" = "#5ad75a", "ESMC 600M" = "#228C22", "Amplify 120M" = "#ffb16c", "Amplify 350M" = "#ff7f0e")

color_dict = c("8M" = "#C6DBEF", "35M" = "#9ECAE1", "150M" = "#6BAED6", "650M" = "#4292C6", "3B" = "#2171B5", "15B" = "#084594", "300M" = "#5ad75a", "600M" = "#228C22", "120M" = "#ffb16c", "350M" = "#ff7f0e")


#5ad75a
DMS_sample_R2_plot <- grouped_DMS_sampling %>%
  ggplot(aes(
      x = Sample_size, 
      y = mean_R2_score,
      color = ModelSize
      )) +
  scale_x_continuous(limits = c(95, 1000000),trans = scales::log_trans(),
                     breaks = scales::log_breaks(),
                     labels = trans_format("log10", math_format(10^.x))
                       ) +
  scale_y_continuous(limits = c(-.3, 1)) +
  geom_errorbar(aes(
      ymin = mean_R2_score - std_R2_score, 
      ymax = mean_R2_score + std_R2_score), 
      width = 0.1,
      alpha = 1,
      #position = position_dodge(width = .2)
      ) +
  geom_line(#position = position_dodge(width = 0.2)
            )+
  geom_point(#position = position_dodge(width = 0.2)
             )+
  scale_color_manual(
    values = color_dict,
    name = "Model Size"
    
    ) +
  
  labs(x= "Sample Size", 
    y = expression(paste("Cross Validation ", R^2)), fill = ""
       ) +
  theme_minimal_grid(12, rel_small = 1)+
  theme(
        legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                   size = .5),
        panel.spacing = unit(.30, "cm"),
      
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(0, 10, 0, 10),
        
        strip.background = element_rect(fill = "gray90", color = "black", size = .5),
  strip.text = element_text(face = "bold", color = "black")
        )+
  facet_grid(Dataset ~ Model, scales = "free")


  # ggsave(DMS_sample_R2_plot,
  #        filename = "DMS_sample_R2_plot.png",
  #        path = here("figs"),
  #        width = 8,
  #       height = 7.5,
  #        dpi=600)


#DMS_sample_R2_plot + facet_grid(cols = vars(Dataset))
DMS_sample_R2_plot


```


```{r}


color_dict = c("8M" = "#C6DBEF", "35M" = "#9ECAE1", "150M" = "#6BAED6", "650M" = "#4292C6", "3B" = "#2171B5", "15B" = "#084594", "300M" = "#5ad75a", "600M" = "#228C22", "120M" = "#ffb16c", "350M" = "#ff7f0e")


sample_coeff_plot <- grouped_DMS_sampling %>%
  ggplot(aes(
      x = Sample_size, 
      y = mean_coeff_score,
      color = ModelSize
      )) +
  scale_x_continuous(limits = c(95, 1000000), trans = scales::log_trans(),
                     breaks = scales::log_breaks(),
                     labels = trans_format("log10", math_format(10^.x))
                       ) +
  scale_y_continuous(limits =c(0, 1350)) +
  #scale_y_continuous(limits = c(NA, 1500)) +
  geom_errorbar(aes(
      ymin = mean_coeff_score - std_coeff_score, 
      ymax = mean_coeff_score + std_coeff_score), 
      width = 0.1,
      alpha = 1,
      #position = position_dodge(width = .2)
      ) +
  geom_line(#position = position_dodge(width = 0.2)
            )+
  geom_point(#position = position_dodge(width = 0.2)
             )+
  scale_color_manual(
    values = color_dict,
    name = 'Model Size'
    ) +
  
  labs(x= "Sample Size", 
    y = "Number of Features"
       ) +
  theme_minimal_grid(12, rel_small = 1)+
  theme(
        legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                   size = .5),
        panel.spacing = unit(.30, "cm"),
      
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(0, 10, 0, 10),
        
        strip.background = element_rect(fill = "gray90", color = "black", size = .5),
  strip.text = element_text(face = "bold", color = "black")
        )+
  facet_grid(Dataset ~ Model, scales = "free")
        
  
  

# ggsave(sample_coeff_plot,
#        filename = "sample_coeff_plot.png",
#        path = here("figs"),
#        width = 8,
#       height = 7.5,
#        dpi=600)


sample_coeff_plot

```








# Figure 2 Assembly
```{r}
# cowplot for DMS 150M data

double_plot <- plot_grid(final_plot,
                  pisces_plot,
                  labels = c('A', 'B'), 
                  label_size = 12, 
                  rel_widths = c(1.05, 1)
                  )


# ggsave(double_plot,
#       filename = "double_lmer.png",
#       path = here("figs"),
#       width = 8,
#       height = 4,
#       dpi=600)
double_plot

```

# Supplementary Figure 1
```{r}

# mutate df so that it is in the correct form
# use code similar to mega plot above to do all the compression methods
# use cowplot to combine them all

supp_data_mutated = data %>%
  mutate(Compression_method = case_when(
    Compression_method == "bos" ~ "BOS",
    Compression_method == "maxPool" ~ "MaxPooling",
    #Compression_method == "mean" ~ "Mean Pooling",
    TRUE ~ Compression_method
  )) %>%
  group_by(Dataset, Compression_method) %>%
  summarize(mean_R2_score = mean(R2_score_test, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = Compression_method, values_from = mean_R2_score)

```

```{r}
methods_no_mean <- c("MaxPooling", "iDCT5", 'iDCT4', "pca1", 'rbf1', 'sigmoid1', "BOS", 'iDCT3', "pca2", 'sigmoid2', 'iDCT2', 'rbf2', 'iDCT1')
  


scatter_plots_list <- list()

for(method in methods_no_mean){
  dot_color = 'black'
  y_label <- ifelse(method == "MaxPooling", "Max Pooling", method)
  
  
  plot <- supp_data_mutated %>%
    ggplot(aes_string(x = "mean", y = method)) + 
    geom_point(size = 1, color = dot_color) +
    scale_x_continuous(limits = c(0, 1)) +
    scale_y_continuous(limits = c(0, 1)) +
    geom_abline(slope = 1, 
                intercept = 0, 
                linetype = "dashed", 
                color = '#0072B2') +
    labs(x = "Mean Pooling", 
         y = y_label) +
    theme_minimal_grid(12, rel_small = 1) +
    theme(
      panel.background = element_rect(fill = "white", 
                                      colour = "white"),
      plot.background = element_rect(fill = "white", 
                                     colour = "white"),
      legend.position = "none",
      panel.border = element_rect(color = "black", 
                                  fill = NA, 
                                  size = .5
                                  ),
      axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
      plot.margin = margin(8, 8, 8, 8)
    )
  
  scatter_plots_list <- c(scatter_plots_list, list(plot))

}

```


```{r}

final_methods_plot <- plot_grid(plotlist = scatter_plots_list, ncol =3)

# ggsave(final_methods_plot,
#        filename = "sup1_DMS_results_R2.png",
#        path = here("figs"),
#        width = 9,
#        height = 12,
#        dpi=600)

final_methods_plot
```

# Supplementary Figure 2 
```{r}
# exclude_datasets <- c('F freq', 'M freq', 'C freq', 'D freq', 'Y freq', 'V freq', 'W freq', 'G freq', 'Q freq', 'S freq', 'P freq', 'H freq', 'T freq')
supp_pisces_mutated = pisces_data %>%
  mutate(Compression_method = case_when(
    Compression_method == "bos" ~ "BOS",
    Compression_method == "maxPool" ~ "MaxPooling",
    #Compression_method == "mean" ~ "Mean Pooling",
    TRUE ~ Compression_method
  )) %>%
  group_by(Dataset, Compression_method) %>%
  summarize(mean_R2_score = mean(R2_score_test, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = Compression_method, values_from = mean_R2_score)

# supp_pisces_mutated <- filter(supp_pisces_mutated, !(Dataset %in% exclude_datasets))

methods_no_mean <- c("BOS", "MaxPooling", "iDCT5", "iDCT4", "iDCT3", "pca1", "iDCT2", "sigmoid1", "rbf1", 'iDCT1', 'pca2', 'sigmoid2', 'rbf2')
  #c("bos", "iDCT", "maxPool", "pca1", "pca2", "rbf1", "rbf2", "sigmoid1", "sigmoid2")

pisces_scatter_plots_list <- list()

for(method in methods_no_mean){

  dot_color = 'black'
  y_label <- ifelse(method == "MaxPooling", "Max Pooling", method)
  
  
  plot <- supp_pisces_mutated %>%
    ggplot(aes_string(x = "mean", y = method)) + 
    geom_point(size = 1, color = dot_color) +
    scale_x_continuous(limits = c(0, 1)) +
    scale_y_continuous(limits = c(0, 1)) +
    geom_abline(slope = 1, 
                intercept = 0, 
                linetype = "dashed", 
                color = '#0072B2'
                ) +
    labs(x = "Mean Pooling", 
         y = y_label) +
    theme_minimal_grid(12, rel_small = 1) +
    theme(
      panel.background = element_rect(fill = "white", 
                                      colour = "white"),
      plot.background = element_rect(fill = "white", 
                                     colour = "white"),
      legend.position = "none",
      panel.border = element_rect(color = "black", 
                                  fill = NA, 
                                  size = .5),
      axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
      plot.margin = margin(8, 8, 8, 8)
    )
  
  pisces_scatter_plots_list <- c(pisces_scatter_plots_list, list(plot))

}



final_methods_pisces <- plot_grid(plotlist = pisces_scatter_plots_list, ncol =3)

# ggsave(final_methods_pisces,
#        filename = "sup2_pisces_R2.png",
#        path = here("figs"),
#        width = 9,
#        height = 12,
#        dpi=600)

final_methods_pisces



```


# Supplementary Figure 4 
```{r}

inc_order=c("BLAT ECOLX 2014", "BRCA1 RING", "IF1 ECOLI", "RL401 2016", "DLG4 RAT", "TIM THETH", "RL401 2013", "RASH HUMAN", "RL401 2014", "YAP1 singles", "HSP82 YEAST", "PABP singles", "BLAT ECOLX 2015", "PABP doubles", "parEparD all")


rev_grouped_multi_mod_DMS <- multi_mod_DMS %>%
  group_by(Dataset, Model) %>%
  filter(Dataset %in% inc_order) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE),
   
  ) %>%
  ungroup()

#c("BRCA1 RING", "UBE4B_MOUSE_Klevit2013_singles", "BRCA1_HUMAN_BRCT", "POLG_HCVJF_Sun2014", "BG505 env")


# rev_grouped_multi_mod_DMS <- rev_grouped_multi_mod_DMS %>%
#   mutate(Dataset = case_when(
#     Dataset == "UBE4B_MOUSE_Klevit2013_singles" ~ "UBE4B MOUSE",
#     Dataset == "BRCA1_HUMAN_BRCT" ~ "BRCA1 BRCT",
#     Dataset == "POLG_HCVJF_Sun2014" ~ "POLG HCVJF",
#     TRUE ~ Dataset
# ))



rev_grouped_multi_mod_DMS$Model <- factor(rev_grouped_multi_mod_DMS$Model, levels = c("ESM2 15B", "ESM2 3B", "ESM2 650M", "ESM2 150M", "ESM2 35M", "ESM2 8M", "ESM1v 650M"))

rev_grouped_multi_mod_DMS$Dataset <- factor(rev_grouped_multi_mod_DMS$Dataset, levels = inc_order)



color_dict = c("ESM1v 650M" = "#D68F6B", "ESM2 8M" = "#C6DBEF", "ESM2 35M" = "#9ECAE1", "ESM2 150M" = "#6BAED6", "ESM2 650M" = "#4292C6", "ESM2 3B" = "#2171B5", "ESM2 15B" = "#084594")

#color_dict <- c("15B" = '#254369','650M' = '#4292C6', "150M" = '#9ECAE1')
```

```{r}


DMS_barplot <- rev_grouped_multi_mod_DMS %>%
  ggplot(aes(y = mean_score, 
         x = Dataset,
         fill = Model
         ))+
  geom_bar(stat = 'identity', 
           width = 0.7,
           position = position_dodge(width = 0.85),
           alpha = 0.85) + 
  scale_fill_manual(values = color_dict)+
  geom_errorbar(aes(
                ymin = mean_score - std_score, 
                ymax = mean_score + std_score),
                width = 0.3,
                position = position_dodge(0.85)) + 
  coord_flip()+ 
  guides(fill = guide_legend(reverse = TRUE))+
  labs(x = "Dataset", 
       y = expression(R^2), 
       fill="Model") +
  theme_minimal_vgrid(12, rel_small = 1) +
  theme(panel.background = element_rect(fill = "white", 
                                        colour ="white"),
      plot.background = element_rect(fill = "white", 
                                     colour = "white"),
      legend.position = "top",
      panel.border = element_rect(color = "black", 
                                  fill = NA, 
                                  size = .5),
      axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
      plot.margin = margin(0, 10, 0, 10)
    )
         


  # ggsave(DMS_barplot,
  #        filename = "DMS_barplot.png",
  #        path = here("figs"),
  #        width = 8,
  #        height = 11,
  #        dpi=600)

 
DMS_barplot
         

```


# Supplementary Figure 5

```{r}
rev_multi_mod_pisces <- grouped_multi_mod_pisces

rev_multi_mod_pisces$Model <- factor(rev_multi_mod_pisces$Model, levels = c("ESM2 15B", "ESM2 3B", "ESM2 650M", "ESM2 150M", "ESM2 35M", "ESM2 8M", "ESM1v 650M"))


```


```{r}

# mean_pisces_150M_650M_15B <- pisces_150M_650M_15B %>%
#   filter(Compression_methd %in% c('mean'))

# mean_pisces_150M_650M_15B$param <- factor(mean_pisces_150M_650M_15B$param, levels = c("15B", "650M", "150M"))
rev_multi_mod_pisces <- grouped_multi_mod_pisces

rev_multi_mod_pisces$Model <- factor(rev_multi_mod_pisces$Model, levels = c("ESM2 15B", "ESM2 3B", "ESM2 650M", "ESM2 150M", "ESM2 35M", "ESM2 8M", "ESM1v 650M"))


#color_dict <- c("esm2 15B" = '#254369','esm2 650M' = '#4292C6', "esm2 150M" = '#9ECAE1')

color_dict = c("ESM1v 650M" = "#D68F6B", "ESM2 8M" = "#C6DBEF", "ESM2 35M" = "#9ECAE1", "ESM2 150M" = "#6BAED6", "ESM2 650M" = "#4292C6", "ESM2 3B" = "#2171B5", "ESM2 15B" = "#084594")



pisces_barplot <- rev_multi_mod_pisces %>%

  ggplot(aes(y = mean_score, 
         x = fct_reorder(Dataset, mean_score),
         fill = Model
         ))+
  geom_bar(stat = 'identity', 
           width = 0.7,
           position = position_dodge(width = 0.85),
           alpha = 0.85) + 
  scale_fill_manual(values = color_dict)+
  geom_errorbar(aes(
                ymin = mean_score - std_score, 
                ymax = mean_score + std_score),
                width = 0.3,
                position = position_dodge(0.85)) + 
  coord_flip()+ 
  guides(fill = guide_legend(reverse = TRUE))+
  labs(x = "Target", 
       y = expression(R^2), 
       fill='Model') +
  theme_minimal_vgrid(12, rel_small = 1) +
  theme(panel.background = element_rect(fill = "white", 
                                        colour ="white"),
      plot.background = element_rect(fill = "white", 
                                     colour = "white"),
      legend.position = "top",
      panel.border = element_rect(color = "black", 
                                  fill = NA, 
                                  size = .5),
      axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
      plot.margin = margin(0, 10, 0, 10)
    )
         


  # ggsave(pisces_barplot,
  #        filename = "pisces_barplot.png",
  #        path = here("figs"),
  #        width = 8,
  #        height = 11,
  #        dpi=600)


 
pisces_barplot
```





# Supp 7

```{r}
histogram_data <- read.csv(here('results/summary_DMS_all_multi_model.csv'))
histogram_data <- histogram_data %>%
  group_by(Dataset) %>%
  summarise(
    dataset_size = median(get('dataset_size')),
  ) %>%
  ungroup()


histogram_data$bin <- cut(histogram_data$dataset_size,
                breaks = c(-Inf, 1000, 3200, 10000, 32000, Inf),
                labels = c("<1000", "1000-3200", "3200-10000", "10000-32000", ">32000"),
                right = FALSE) 

histo_plot <- histogram_data %>%
 ggplot(aes(x = bin)) +
  geom_bar(fill = "gray",) +  
  labs(x = "Number of Samples", 
       y = "Number of Datasets", 
       title = "" )+
   theme_minimal_hgrid(12, rel_small = 1) +  
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.background = element_rect(fill = "white", colour = "white"),
    axis.text.x=element_text(size=12),
    axis.text.y=element_text(size=10),

    panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
    axis.line = element_blank(),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.y = element_line(color = "black"),
    plot.margin = margin(10,10,0,10)
  ) 
  
histo_plot


# ggsave(histo_plot, 
#        filename = "sup6_DMS_sample_size_v02.png",
#        path = here("figs"),
#        width = 7,
#        height = 5,
#        dpi=600)

```






# Fig 3 multimod assembly
```{r}
fig3_multi_mod <- plot_grid(DMS_all_boxplot, 
                            pisces_all_boxplot, 
                            labels = c('A', 'B'), 
                            ncol = 1, 
                            rel_heights = c(1.1, 1))

# ggsave(fig3_multi_mod,
#        filename = "fig3_multi_mod.png",
#        path = here("figs"),
#        width = 8,
#        height = 8,
#        dpi=600)

fig3_multi_mod
```

